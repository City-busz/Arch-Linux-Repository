--- PKGBUILD.orig	2011-11-08 18:40:37.000000000 +0100
+++ PKGBUILD	2011-11-10 10:30:54.771059174 +0100
@@ -1,9 +1,9 @@
-# $Id: PKGBUILD 137970 2011-09-13 10:37:07Z andrea $
-# Maintainer: Andrea Scarpino <andrea@archlinux.org>
+# Maintainer: György Balló <ballogy@freestart.hu>
+# Contributor: Andrea Scarpino <andrea@archlinux.org>
 # Contributor: Pierre Schmitz <pierre@archlinux.de>
 
-pkgbase=qt
-pkgname=('qt' 'qt-private-headers')
+pkgbase=qt-ubuntu
+pkgname=('qt-ubuntu' 'qt-private-headers-ubuntu')
 pkgver=4.7.4
 pkgrel=3
 arch=('i686' 'x86_64')
@@ -18,13 +18,27 @@
 source=("ftp://ftp.qt.nokia.com/qt/source/${_pkgfqn}.tar.gz"
         'assistant.desktop' 'designer.desktop' 'linguist.desktop'
         'qtconfig.desktop'
-        'blacklist-diginotar-certs.diff')
+        'blacklist-diginotar-certs.diff'
+        'kubuntu_14_systemtrayicon.diff'
+        'kubuntu_15_appmenu.diff'
+        'kubuntu_16_qt-designer-toplevel-mode-menubar.diff'
+        'kubuntu_26_dbusconnection_pointer.diff'
+        'kubuntu_92_qml_memory_leak.diff'
+        'kubuntu_93_disable_overlay_scrollbars.diff'
+        'kubuntu_96_fix_qml_crash.diff')
 md5sums=('9831cf1dfa8d0689a06c2c54c5c65aaf'
          'fc211414130ab2764132e7370f8e5caa'
          '85179f5e0437514f8639957e1d8baf62'
          'f11852b97583610f3dbb669ebc3e21bc'
          '6b771c8a81dd90b45e8a79afa0e5bbfd'
-         'd875a2a7639de3bd63dc519c13b4d069')
+         'd875a2a7639de3bd63dc519c13b4d069'
+         'c4ef8871ea8f875310ffc9ed8550d6c3'
+         'd14c41725e00f9619c5a19aa17d21768'
+         'b5f762f3d072ac90da5fab3ad78a3eb8'
+         '90171e8b5c840360a7ab67f5613a91ea'
+         'e4c6c37959d5d763529840491fea5cd0'
+         'bf5a0db014cba9710be78f9f88f655aa'
+         '1d6f6eebb1943ed3eb1a25600387d81b')
 
 build() {
 	unset QMAKESPEC
@@ -39,6 +53,27 @@
 
     patch -p1 -i "${srcdir}"/blacklist-diginotar-certs.diff
 
+    # Introduce a plugin system for QSystemTrayIcon (required for sni-qt)
+    patch -p1 -i "${srcdir}"/kubuntu_14_systemtrayicon.diff
+
+    # Add support for external menu bars exported over dbus (required for appmenu-qt)
+    patch -p1 -i "${srcdir}"/kubuntu_15_appmenu.diff
+
+    # Keep designer working with global menu when in toplevel mode  (fix for appmenu-qt)
+    patch -p1 -i "${srcdir}"/kubuntu_16_qt-designer-toplevel-mode-menubar.diff
+
+    # Add a way to obtain the DBusConnection* pointer from a QDBusConnection (required for dconf-qt)
+    patch -p1 -i "${srcdir}"/kubuntu_26_dbusconnection_pointer.diff
+
+    # Immediatly delete obj in release() rather than using deleteLater() (fix for unity-2d)
+    patch -p1 -i "${srcdir}"/kubuntu_92_qml_memory_leak.diff
+
+    # Use ubuntu_gtk_disable_overlay_scrollbar() to get rid of overlay scrollbars (fix for overlay-scrollbar)
+    patch -p1 -i "${srcdir}"/kubuntu_93_disable_overlay_scrollbars.diff
+
+    # Fixed broken window surface flush when depth is 24 and bpp is not 32 (fix for unity-2d)
+    patch -p1 -i "${srcdir}"/kubuntu_96_fix_qml_crash.diff
+
     sed -i "s|-O2|$CXXFLAGS|" mkspecs/common/g++.conf
 	sed -i "/^QMAKE_RPATH/s| -Wl,-rpath,||g" mkspecs/common/g++.conf
 	sed -i "/^QMAKE_LFLAGS\s/s|+=|+= $LDFLAGS|g" mkspecs/common/g++.conf
@@ -85,8 +120,8 @@
 	make
 }
 
-package_qt() {
-    pkgdesc='A cross-platform application and UI framework'
+package_qt-ubuntu() {
+    pkgdesc="A cross-platform application and UI framework with Ubuntu's modifications"
     depends=('libtiff' 'libpng' 'libmng' 'sqlite3' 'ca-certificates' 'glib2' 'dbus'
       'fontconfig' 'libgl' 'libsm' 'libxrandr' 'libxv' 'libxi' 'alsa-lib'
       'xdg-utils' 'hicolor-icon-theme' 'desktop-file-utils')
@@ -96,6 +131,8 @@
 	  'libxinerama: Xinerama support'
 	  'libxcursor: Xcursor support'
 	  'libxfixes: Xfixes support')
+    provides=('qt=4.7.3')
+    conflicts=('qt')
     install='qt.install'
 	
     cd $srcdir/$_pkgfqn
@@ -123,9 +160,11 @@
 		-exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d;s/\(QMAKE_PRL_LIBS =\).*/\1/' {} \;
 }
 
-package_qt-private-headers(){
-    pkgdesc="Qt private headers for development"
+package_qt-private-headers-ubuntu(){
+    pkgdesc="Qt private headers for development with Ubuntu's modifications"
     depends=("qt=${pkgver}")
+    provides=('qt-private-headers=4.7.3')
+    conflicts=('qt-private-headers')
 
     install -d ${pkgdir}/usr/include/{QtCore,QtDeclarative,QtGui,QtScript}
     install -d ${pkgdir}/usr/src/{corelib,declarative,gui,script}
